<script>
    // This is the special "wrapper" that waits for the page to load
    document.addEventListener('DOMContentLoaded', () => {
        // --- Getting all the buttons and displays from the HTML ---
        const analyzeBtn = document.getElementById('analyzeBtn');
        const symbolInput = document.getElementById('symbolInput');
        const loader = document.getElementById('loader');
        const resultsDiv = document.getElementById('results');
        const errorDiv = document.getElementById('error-message');
        const filterGroup = document.getElementById('filterGroup');

        // --- Setting up the buttons to call the function when clicked ---
        analyzeBtn.addEventListener('click', analyzeStock);
        filterGroup.addEventListener('change', analyzeStock);
        symbolInput.addEventListener('keypress', function(event) {
            if (event.key === "Enter") {
                analyzeBtn.click();
            }
        });

        // --- A helper function to make numbers look nice (green for positive, red for negative) ---
        function formatCell(value, isPercent = false, decimals = 2) {
            if (typeof value !== 'number' || isNaN(value)) return value;
            const fixedValue = value.toFixed(decimals);
            const className = value > 0 ? 'positive' : value < 0 ? 'negative' : '';
            return `<span class="${className}">${fixedValue}${isPercent ? '%' : ''}</span>`;
        }

        // --- This is the MAIN function that does all the work! ---
        async function analyzeStock() {
            const symbol = symbolInput.value.trim();
            if (!symbol) {
                errorDiv.textContent = "Please enter a stock symbol.";
                errorDiv.style.display = 'block';
                return;
            }

            const filter = document.querySelector('input[name="filter"]:checked').value;

            // Show the spinning loader and hide old results
            loader.style.display = 'block';
            resultsDiv.style.display = 'none';
            errorDiv.style.display = 'none';

            try {
                console.log(`Fetching data for symbol: ${symbol} with filter: ${filter}`);
                const apiUrl = `https://stephen-stock-analyzer.onrender.com/api/analyze/${symbol}?filter=${filter}`;
                console.log(`API URL: ${apiUrl}`);

                const response = await fetch(apiUrl);
                console.log(`Response status: ${response.status} ${response.statusText}`);

                const data = await response.json();
                console.log('Response data:', data);

                if (!response.ok) {
                    throw new Error(data.error || 'Something went wrong');
                }

                // --- If everything was successful, fill in the tables ---
                // Adjust data structure to match what frontend expects
                // Assuming backend returns { weekly_data, statistics }
                if (!data.weekly_data || !data.statistics) {
                    throw new Error("Unexpected data format from server");
                }

                // Mock the expected structure for current_info
                const current_info = {
                    current_week: data.weekly_data.length > 0 ? data.weekly_data[data.weekly_data.length - 1].week_start_date : 'N/A',
                    prior_week_return: data.weekly_data.length > 1 ? data.weekly_data[data.weekly_data.length - 2].week_return : 0
                };

                // Populate Info Bar
                document.getElementById('currentWeek').textContent = current_info.current_week;
                document.getElementById('priorWeekReturn').innerHTML = formatCell(current_info.prior_week_return, true);

                // Populate Stats Table (adjust statistics format)
                const statsTbody = document.getElementById('statsTable').querySelector('tbody');
                statsTbody.innerHTML = '';
                const stats = data.statistics;
                // Create a simple stats array since frontend expects multiple week stats
                const mockStats = [
                    {
                        week_number: 'All',
                        count: stats.total_weeks,
                        avg_return: stats.average_return,
                        pct_profitable: stats.win_rate,
                        profit_factor: stats.profit_factor,
                        sharpe_ratio: stats.sharpe_ratio,
                        std_dev: data.weekly_data.length > 0 ? (data.weekly_data.map(w => w.week_return).reduce((a, b) => a + b, 0) / data.weekly_data.length) * 0.2 : 0 // Rough approximation
                    }
                ];
                mockStats.forEach(stat => {
                    const row = statsTbody.insertRow();
                    row.innerHTML = `
                        <td>${stat.week_number}</td>
                        <td>${stat.count}</td>
                        <td>${formatCell(stat.avg_return, true)}</td>
                        <td>${formatCell(stat.pct_profitable, true)}</td>
                        <td>${formatCell(stat.profit_factor)}</td>
                        <td>${formatCell(stat.sharpe_ratio)}</td>
                        <td>${formatCell(stat.std_dev, true)}</td>
                    `;
                });

                // Populate History Table
                document.getElementById('historyTitle').textContent = `Recent Weekly Data`;
                const historyTbody = document.getElementById('historyTable').querySelector('tbody');
                historyTbody.innerHTML = '';
                data.weekly_data.slice(-20).forEach(week => {
                    const weekDate = new Date(week.week_start_date);
                    const row = historyTbody.insertRow();
                    row.innerHTML = `
                        <td>${weekDate.toLocaleString('default', { month: 'short', day: 'numeric' })}</td>
                        <td>${weekDate.getFullYear()}</td>
                        <td>${week.open_price.toFixed(2)}</td>
                        <td>${week.high.toFixed(2)}</td>
                        <td>${week.low.toFixed(2)}</td>
                        <td>${week.close_price.toFixed(2)}</td>
                        <td>${formatCell(week.week_return, true)}</td>
                    `;
                });

                resultsDiv.style.display = 'block';

            } catch (err) {
                console.error('Fetch error:', err);
                errorDiv.textContent = `Error: ${err.message}`;
                errorDiv.style.display = 'block';
            } finally {
                // Hide the spinning loader when we're done
                loader.style.display = 'none';
            }
        }
    });
</script>